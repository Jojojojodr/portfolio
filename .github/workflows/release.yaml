name: Create Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            name: portfolio-linux-amd64
            archive: tar.gz
          - os: windows-latest
            goos: windows
            goarch: amd64
            name: portfolio-windows-amd64
            archive: zip
          - os: macos-latest
            goos: darwin
            goarch: amd64
            name: portfolio-darwin-amd64
            archive: tar.gz
          - os: macos-latest
            goos: darwin
            goarch: arm64
            name: portfolio-darwin-arm64
            archive: tar.gz
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Tailwind CSS (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          curl -sLO https://github.com/tailwindlabs/tailwindcss/releases/latest/download/tailwindcss-linux-x64
          chmod +x tailwindcss-linux-x64
          sudo mv tailwindcss-linux-x64 /usr/local/bin/tailwindcss

      - name: Install Tailwind CSS (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          curl -sLO https://github.com/tailwindlabs/tailwindcss/releases/latest/download/tailwindcss-macos-x64
          chmod +x tailwindcss-macos-x64
          sudo mv tailwindcss-macos-x64 /usr/local/bin/tailwindcss

      - name: Install Tailwind CSS (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          curl -sLO https://github.com/tailwindlabs/tailwindcss/releases/latest/download/tailwindcss-windows-x64.exe
          move tailwindcss-windows-x64.exe C:\Windows\System32\tailwindcss.exe

      - name: Install templ
        run: go install github.com/a-h/templ/cmd/templ@v0.3.865

      - name: Install Go dependencies
        run: go mod download

      - name: Build Tailwind CSS
        run: tailwindcss -i ./static/css/input.css -o ./static/css/style.css --minify

      - name: Generate templ files
        run: |
          templ generate

      - name: Create release package
        run: |
          mkdir -p release
          cp -r static release/ || copy static release\ /E
          cp -r database release/ || copy database release\ /E /Q 2>nul || echo "Database folder not found"
          cp .env.example release/ || copy .env.example release\
          cp RELEASE.md release/README.md || copy RELEASE.md release\README.md

      - name: Build binary (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          CGO_ENABLED=1 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -ldflags="-s -w" -o release/portfolio ./cmd/main.go

      - name: Build binary (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          $env:CGO_ENABLED=1
          $env:GOOS="${{ matrix.goos }}"
          $env:GOARCH="${{ matrix.goarch }}"
          go build -ldflags="-s -w" -o release/portfolio.exe ./cmd/main.go

      - name: Create archive (tar.gz)
        if: matrix.archive == 'tar.gz'
        run: |
          tar -czf ${{ matrix.name }}.tar.gz -C release .

      - name: Create archive (zip) - Unix
        if: matrix.archive == 'zip' && matrix.os != 'windows-latest'
        run: |
          cd release
          zip -r ../${{ matrix.name }}.zip .

      - name: Create archive (zip) - Windows
        if: matrix.archive == 'zip' && matrix.os == 'windows-latest'
        run: |
          Compress-Archive -Path release\* -DestinationPath ${{ matrix.name }}.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}.${{ matrix.archive }}

  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## Changes in this Release
            - Automated release for ${{ github.ref_name }}
            
            ## Downloads
            Choose the archive for your platform:
            - **Linux**: portfolio-linux-amd64.tar.gz (native build with SQLite support)
            - **Windows**: portfolio-windows-amd64.zip (native build with SQLite support)  
            - **macOS (Intel)**: portfolio-darwin-amd64.tar.gz (native build with SQLite support)
            - **macOS (Apple Silicon)**: portfolio-darwin-arm64.tar.gz (native build with SQLite support)
            
            ## Features
            - **All platforms**: Native compilation with full SQLite support
            - **CGO enabled**: Maximum performance and compatibility
            - **Platform optimized**: Built on native runners for best results
            
            ## Installation
            1. Download and extract the appropriate archive for your platform
            2. Set up environment variables:
               ```bash
               cp .env.example .env
               # Edit .env with your settings
               ```
            3. Make executable (Linux/macOS): `chmod +x portfolio`
            4. Run with: `./portfolio -p 8080 -d sqlite -t your-secret-token`
            
            ## What's included
            - Natively compiled binary with all dependencies
            - Static assets (CSS, images, etc.)
            - Frontend templates
            - Database directory structure
            - Example environment configuration
          files: |
            portfolio-linux-amd64/portfolio-linux-amd64.tar.gz
            portfolio-windows-amd64/portfolio-windows-amd64.zip
            portfolio-darwin-amd64/portfolio-darwin-amd64.tar.gz
            portfolio-darwin-arm64/portfolio-darwin-arm64.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}